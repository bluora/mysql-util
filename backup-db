#!/bin/bash
# backup-db: Backup a database.

if [ "$(whoami)" == 'root' ]; then
    echo "You need to run as a local user for this script.";
    exit 1;
fi

. "${BASH_SOURCE%/*}/db.conf"

if [ -z "$1" ]; then
  echo "backup-db [source]";
  echo "";
  echo -e "\tsource\t\t- The source database (from list)";
  echo "";
  exit 1;
fi

SOURCE_DB=$1

MYSQL_CMD="mysql --login-path=$SOURCE_DB -e \";\""

if [ ! $MYSQL_CMD 2>/dev/null ]; then
    echo "Incorrect MySQL login details for '$SOURCE_DB'"
    echo ""
    exit 1;
fi

DATE=`date +%Y%m%d_%H%M%S`

# Backup destination
mkdir -p "./backups/saved"
mysqldump --login-path=$SOURCE_DB --add-drop-table $SOURCE_DB > "./backups/saved/TEMP_${SOURCE_DB}_$DATE.sql"
perl -pe 's/\sDEFINER=`[^`]+`@`[^`]+`//' < "./backups/saved/TEMP_${SOURCE_DB}_$DATE.sql" > "./backups/saved/${SOURCE_DB}_$DATE.sql"
unlink "./backups/saved/TEMP_${SOURCE_DB}_$DATE.sql" > /dev/null 2>&1

echo "./backups/saved/${SOURCE_DB}_$DATE.sql"
